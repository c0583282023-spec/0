<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Pulse - 专抓 驻转</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Noto+Sans+Hebrew:wght@300;700;900&display=swap" rel="stylesheet">
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            background-color: #020617;
            font-family: 'Noto Sans Hebrew', 'Orbitron', sans-serif;
            color: white;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .grid-bg {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(34, 211, 238, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(34, 211, 238, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            perspective: 1000px;
            transform: rotateX(60deg) translateY(-20%) scale(2);
            transform-origin: top;
            z-index: -5;
            opacity: 0.3;
            animation: grid-move 20s linear infinite;
        }
        @keyframes grid-move {
            0% { background-position: 0 0; }
            100% { background-position: 0 500px; }
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .neon-text {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.5), 0 0 20px rgba(34, 211, 238, 0.3);
        }
        .dir-rtl { direction: rtl; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Added data-type="module" and Babel integration for direct browser execution -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        const TABLES_LIST = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
        const DIFFICULTIES = {
            easy: { label: '拽', tables: [2, 3, 4, 5], time: 90, color: 'text-green-400', border: 'border-green-500/30' },
            medium: { label: '', tables: [2, 3, 4, 5, 6, 7, 8, 9, 10], time: 60, color: 'text-yellow-400', border: 'border-yellow-500/30' },
            hard: { label: '拽砖', tables: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], time: 45, color: 'text-red-400', border: 'border-red-500/30' },
            custom: { label: '转', tables: [], time: 60, color: 'text-cyan-400', border: 'border-cyan-500/30' }
        };

        const App = () => {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');
            
            const [role, setRole] = useState('student');
            const [screen, setScreen] = useState('welcome');
            const [playerName, setPlayerName] = useState('');
            const [difficulty, setDifficulty] = useState('medium');
            const [selectedTables, setSelectedTables] = useState([2, 3, 4, 5]);
            
            const [currentProblem, setCurrentProblem] = useState(null);
            const [options, setOptions] = useState([]);
            const [score, setScore] = useState(0);
            const [streak, setStreak] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [isGameOver, setIsGameOver] = useState(false);
            const [feedback, setFeedback] = useState(null);
            
            const [roomId, setRoomId] = useState('');
            const [roomData, setRoomData] = useState(null);
            const [gameMode, setGameMode] = useState('solo');
            const [history, setHistory] = useState([]);

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js');
                        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js');
                        const { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, addDoc, getDoc, query } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');

                        const config = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config;
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neon-pulse-final';

                        const api = { doc, setDoc, onSnapshot, updateDoc, collection, addDoc, getDoc, query };
                        setFb({ auth, db, appId, api });

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setLoading(false);
                            }
                        });
                    } catch (e) {
                        console.error("Firebase Initialization Error:", e);
                        setErrorMessage('砖转 专. 住 专注 转 祝.');
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!fb || !user || !roomId || screen === 'welcome') return;
                const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId);
                const unsub = fb.api.onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setRoomData(data);
                        if (data.status === 'playing' && screen === 'lobby') {
                            setGameMode('battle');
                            startGame(data.tables, data.time);
                        }
                    }
                }, (err) => {
                    if (err.code === 'permission-denied') setErrorMessage('注转 专砖转 专.');
                });
                return () => unsub();
            }, [fb, user, roomId, screen]);

            useEffect(() => {
                if (!fb || !user || screen !== 'teacher-dashboard') return;
                const historyRef = fb.api.collection(fb.db, 'artifacts', fb.appId, 'public', 'data', 'history');
                const unsub = fb.api.onSnapshot(historyRef, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setHistory(data.sort((a, b) => b.timestamp - a.timestamp));
                });
                return () => unsub();
            }, [fb, user, screen]);

            const generateProblem = (tables = selectedTables) => {
                const active = (tables && tables.length > 0) ? tables : [2, 3, 4, 5];
                const t1 = active[Math.floor(Math.random() * active.length)];
                const t2 = Math.floor(Math.random() * 11) + 2;
                const ans = t1 * t2;
                let opts = new Set([ans]);
                while (opts.size < 4) {
                    const w = (t1 + (Math.random() > 0.5 ? 1 : -1)) * (t2 + Math.floor(Math.random() * 3) - 1);
                    if (w > 0 && w !== ans) opts.add(w);
                    else opts.add(Math.floor(Math.random() * 100) + 1);
                }
                setCurrentProblem({ t1, t2, ans });
                setOptions(Array.from(opts).sort(() => Math.random() - 0.5));
            };

            const startGame = (tablesFromRoom, timeFromRoom) => {
                const finalTables = tablesFromRoom || (difficulty === 'custom' ? selectedTables : DIFFICULTIES[difficulty].tables);
                const finalTime = timeFromRoom || DIFFICULTIES[difficulty].time;
                setScore(0);
                setStreak(0);
                setTimeLeft(finalTime);
                setIsGameOver(false);
                setSelectedTables(finalTables);
                setScreen('game');
                generateProblem(finalTables);
            };

            useEffect(() => {
                if (screen === 'game' && timeLeft > 0 && !isGameOver) {
                    const timer = setTimeout(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && screen === 'game' && !isGameOver) {
                    finishGame();
                }
            }, [timeLeft, screen, isGameOver]);

            const handleAnswer = async (val) => {
                if (!currentProblem || !fb || !user) return;
                if (val === currentProblem.ans) {
                    const newScore = score + (10 * (streak + 1));
                    const newStreak = streak + 1;
                    setScore(newScore);
                    setStreak(newStreak);
                    setFeedback({ type: 'correct', val: '!' });
                    if (gameMode === 'battle' && roomId) {
                        const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId);
                        fb.api.updateDoc(roomRef, { [`players.${user.uid}.score`]: newScore, [`players.${user.uid}.streak`]: newStreak });
                    }
                } else {
                    setStreak(0);
                    setFeedback({ type: 'wrong', val: `驻住..  ${currentProblem.ans}` });
                }
                setTimeout(() => { setFeedback(null); generateProblem(); }, 600);
            };

            const finishGame = async () => {
                setIsGameOver(true);
                setScreen('results');
                if (user && fb) {
                    const historyRef = fb.api.collection(fb.db, 'artifacts', fb.appId, 'public', 'data', 'history');
                    await fb.api.addDoc(historyRef, {
                        name: playerName || '专转',
                        score,
                        difficulty: difficulty === 'custom' ? '转' : DIFFICULTIES[difficulty].label,
                        timestamp: Date.now()
                    });
                    if (gameMode === 'battle' && roomId) {
                        const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId);
                        await fb.api.updateDoc(roomRef, { [`players.${user.uid}.finished`]: true });
                    }
                }
            };

            const createRoom = async () => {
                setErrorMessage('');
                if (!playerName.trim() || !user || !fb) return;
                const rid = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', rid);
                const roomSettings = {
                    id: rid, host: user.uid, status: 'waiting',
                    tables: difficulty === 'custom' ? selectedTables : DIFFICULTIES[difficulty].tables,
                    time: difficulty === 'custom' ? 60 : DIFFICULTIES[difficulty].time,
                    players: { [user.uid]: { name: playerName, score: 0, streak: 0, finished: false } },
                    createdAt: Date.now()
                };
                try {
                    await fb.api.setDoc(roomRef, roomSettings);
                    setRoomId(rid);
                    setGameMode('battle');
                    setScreen('lobby');
                } catch (e) { setErrorMessage('砖 爪专转 专.'); }
            };

            const joinRoom = async () => {
                setErrorMessage('');
                if (!playerName.trim() || !roomId.trim() || !user || !fb) return;
                const rid = roomId.trim().toUpperCase();
                const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', rid);
                try {
                    const snap = await fb.api.getDoc(roomRef);
                    if (snap.exists()) {
                        await fb.api.updateDoc(roomRef, { [`players.${user.uid}`]: { name: playerName, score: 0, streak: 0, finished: false } });
                        setRoomId(rid);
                        setGameMode('battle');
                        setScreen('lobby');
                    } else { setErrorMessage('专  爪.'); }
                } catch (e) { setErrorMessage('砖 爪专驻转.'); }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-cyan-400 font-bold animate-pulse text-xs italic uppercase">Loading Neon Pulse...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col items-center">
                    <div className="grid-bg"></div>
                    <header className="w-full p-6 flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-white/5 sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-cyan-500 rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(6,182,212,0.5)]"><span className="font-black text-white italic">N</span></div>
                            <h1 className="text-xl font-black tracking-tighter bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text text-transparent uppercase italic">Neon Pulse</h1>
                        </div>
                        <div className="flex gap-2">
                            {screen !== 'welcome' && <button onClick={() => setScreen('welcome')} className="p-2 glass rounded-lg px-4 font-bold text-xs uppercase tracking-widest">Home</button>}
                            {role === 'teacher' && screen === 'welcome' && <button onClick={() => setScreen('teacher-dashboard')} className="bg-fuchsia-600 px-4 py-1 rounded-lg text-[10px] font-black shadow-lg">Teacher</button>}
                        </div>
                    </header>
                    <main className="flex-1 w-full max-w-2xl p-6 flex flex-col items-center justify-center">
                        {errorMessage && <div className="w-full mb-6 p-4 bg-red-500/20 border border-red-500/50 rounded-xl text-red-200 text-center font-bold text-sm">{errorMessage}</div>}
                        {screen === 'welcome' && (
                            <div className="w-full space-y-10 text-center animate-in fade-in slide-in-from-bottom-4">
                                <div className="space-y-2">
                                    <h2 className="text-5xl font-black leading-tight italic uppercase italic">专抓 <span className="text-cyan-400 neon-text">驻转</span></h2>
                                    <p className="text-gray-500 font-bold uppercase tracking-widest text-[10px]">Neon Pulse Learning</p>
                                </div>
                                <div className="glass p-8 rounded-[2.5rem] space-y-8 shadow-2xl relative overflow-hidden">
                                    <div className="flex bg-black/40 p-1 rounded-xl border border-white/5">
                                        <button onClick={() => setRole('student')} className={`flex-1 py-3 rounded-lg text-xs font-black transition ${role === 'student' ? 'bg-cyan-600 text-white shadow-lg' : 'text-gray-500'}`}>STUDENT</button>
                                        <button onClick={() => setRole('teacher')} className={`flex-1 py-3 rounded-lg text-xs font-black transition ${role === 'teacher' ? 'bg-fuchsia-600 text-white shadow-lg' : 'text-gray-500'}`}>TEACHER</button>
                                    </div>
                                    <input type="text" placeholder=" 砖 砖?" className="w-full bg-black/50 border-2 border-white/5 rounded-2xl px-6 py-4 text-xl focus:border-cyan-500 outline-none text-center font-bold placeholder:text-gray-700" value={playerName} onChange={e => setPlayerName(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => { if(!playerName.trim()) return; setGameMode('solo'); setScreen('difficulty'); }} className="flex flex-col items-center gap-3 p-6 bg-white/5 hover:bg-cyan-500/10 rounded-3xl border border-white/5 transition active:scale-95 group shadow-lg">
                                            <span className="text-cyan-400 text-2xl font-black italic">SOLO</span>
                                            <span className="text-[10px] font-bold uppercase">砖拽 </span>
                                        </button>
                                        <button onClick={() => { if(!playerName.trim()) return; setScreen('multi-choice'); }} className="flex flex-col items-center gap-3 p-6 bg-white/5 hover:bg-fuchsia-500/10 rounded-3xl border border-white/5 transition active:scale-95 group shadow-lg">
                                            <span className="text-fuchsia-400 text-2xl font-black italic">BATTLE</span>
                                            <span className="text-[10px] font-bold uppercase">转专转 专转</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {screen === 'difficulty' && (
                            <div className="w-full space-y-6 animate-in slide-in-from-bottom-6">
                                <h2 className="text-3xl font-black text-center italic uppercase italic">Select <span className="text-cyan-400">Level</span></h2>
                                {Object.entries(DIFFICULTIES).map(([k, d]) => (
                                    <button key={k} onClick={() => { setDifficulty(k); if(k==='custom') setScreen('solo-config'); else startGame(); }} className={`w-full flex items-center justify-between p-8 glass rounded-3xl hover:bg-white/10 transition active:scale-95 border-l-8 ${d.border.replace('border', 'border-l')}`}>
                                        <div className="text-right"><div className="text-2xl font-black">{d.label}</div><div className="text-xs text-gray-500 font-bold italic">{k==='custom'?'专 转':`转: ${d.tables.join(', ')}`}</div></div>
                                        <div className="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-xl border border-white/5 font-black text-xs tabular-nums">{d.time}s</div>
                                    </button>
                                ))}
                            </div>
                        )}
                        {screen === 'game' && currentProblem && (
                            <div className="w-full flex flex-col gap-8 animate-in zoom-in">
                                <div className="flex justify-between items-center glass p-6 rounded-[2.5rem] shadow-xl border-white/10">
                                    <div className="text-center"><div className="text-[9px] text-cyan-400 font-black uppercase tracking-[0.2em]">Score</div><div className="text-4xl font-black tabular-nums">{score}</div></div>
                                    <div className={`w-20 h-20 rounded-full border-[6px] flex items-center justify-center transition-all ${timeLeft < 10 ? 'border-red-500 text-red-500 animate-pulse scale-110 shadow-[0_0_20px_rgba(239,68,68,0.4)]' : 'border-white/10'}`}><span className="text-4xl font-black tabular-nums">{timeLeft}</span></div>
                                    <div className="text-center"><div className="text-[9px] text-fuchsia-400 font-black uppercase tracking-[0.2em]">Streak</div><div className="text-4xl font-black tabular-nums">{streak}</div></div>
                                </div>
                                <div className="relative glass p-20 rounded-[4rem] flex flex-col items-center gap-4 shadow-2xl overflow-hidden border-cyan-500/20">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-400 to-transparent"></div>
                                    <div className="text-8xl font-black flex items-center gap-6 italic tracking-tighter tabular-nums drop-shadow-[0_0_20px_rgba(34,211,238,0.3)]"><span>{currentProblem.t1}</span><span className="text-cyan-400 text-6xl"></span><span>{currentProblem.t2}</span></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 w-full">
                                    {options.map((o, i) => (
                                        <button key={i} onClick={() => handleAnswer(o)} className="glass py-12 rounded-[2.5rem] text-6xl font-black hover:border-cyan-400/50 hover:bg-white/5 transition active:scale-90 shadow-xl tabular-nums border-white/5">{o}</button>
                                    ))}
                                </div>
                                {gameMode === 'battle' && roomData && (
                                    <div className="w-full bg-white/5 p-5 rounded-[2.5rem] border border-white/5 space-y-4 shadow-inner">
                                        <p className="text-[9px] text-gray-600 font-black tracking-[0.3em] text-center uppercase">Live Ranking</p>
                                        <div className="space-y-3">
                                            {Object.entries(roomData.players || {}).sort((a,b) => b[1].score - a[1].score).map(([uid, p]) => (
                                                <div key={uid} className="space-y-1">
                                                    <div className="flex justify-between items-center px-2"><span className={`text-[10px] font-black uppercase tracking-wider ${uid === user.uid ? 'text-cyan-400' : 'text-gray-500'}`}>{p.name}</span><span className="text-[10px] font-black tabular-nums">{p.score}</span></div>
                                                    <div className="h-1 bg-black/40 rounded-full overflow-hidden"><div className={`h-full transition-all duration-700 ${uid === user.uid ? 'bg-cyan-500' : 'bg-gray-700'}`} style={{ width: `${Math.max(5, Math.min(100, (p.score/1500)*100))}%` }}></div></div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {screen === 'results' && (
                            <div className="text-center space-y-10 animate-in zoom-in">
                                <div className="text-8xl mb-4 drop-shadow-[0_0_30px_rgba(250,204,21,0.5)]"></div>
                                <div className="glass p-16 rounded-[4rem] shadow-3xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-400 to-fuchsia-500"></div>
                                    <div className="text-[10px] font-black text-gray-500 uppercase tracking-widest">Final Score</div>
                                    <div className="text-9xl font-black mb-10 italic tabular-nums drop-shadow-lg">{score}</div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="bg-white/5 p-8 rounded-3xl border border-white/5 text-center"><div className="text-fuchsia-400 text-4xl font-black tabular-nums">{streak}</div><div className="text-[9px] text-gray-500 uppercase font-black mt-2 tracking-widest italic">Max Streak</div></div>
                                        <div className="bg-white/5 p-8 rounded-3xl border border-white/5 text-center"><div className="text-cyan-400 text-4xl font-black tabular-nums">{Math.floor(score/10)}</div><div className="text-[9px] text-gray-500 uppercase font-black mt-2 tracking-widest italic">Correct Hits</div></div>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => { setScreen('welcome'); setGameMode('solo'); }} className="flex-1 py-6 glass rounded-3xl font-black uppercase tracking-widest hover:bg-white/10 transition border-white/10 text-xs">Menu</button>
                                    <button onClick={() => startGame()} className="flex-1 py-6 bg-gradient-to-r from-cyan-600 to-blue-700 rounded-3xl font-black uppercase tracking-widest shadow-2xl hover:scale-105 transition text-xs">Restart</button>
                                </div>
                            </div>
                        )}
                        {screen === 'multi-choice' && (
                            <div className="w-full space-y-8 animate-in slide-in-from-bottom-6">
                                <div className="glass p-10 rounded-[3.5rem] space-y-10 border-fuchsia-500/20 shadow-2xl">
                                    <h3 className="text-2xl font-black italic uppercase tracking-tighter">Multiplayer <span className="text-fuchsia-400">Battle</span></h3>
                                    <div className="space-y-4">
                                        <div className="flex gap-3">
                                            <input type="text" placeholder="ROOM CODE" className="flex-1 bg-black/60 border-2 border-white/5 rounded-2xl px-6 py-4 uppercase text-center font-black tracking-[0.4em] text-2xl focus:border-fuchsia-500 outline-none shadow-inner" value={roomId} onChange={e => setRoomId(e.target.value)} />
                                            <button onClick={joinRoom} className="bg-fuchsia-600 px-8 py-4 rounded-2xl font-black hover:bg-fuchsia-500 transition shadow-lg uppercase text-[10px] tracking-widest">JOIN</button>
                                        </div>
                                    </div>
                                    <div className="relative flex items-center justify-center py-2"><div className="w-full border-t border-white/5 absolute"></div><span className="relative bg-[#020617] px-6 text-[10px] font-black text-gray-700 uppercase italic tracking-widest italic">Or</span></div>
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-3 gap-2">{['easy', 'medium', 'hard'].map(k => (<button key={k} onClick={() => setDifficulty(k)} className={`py-3 rounded-xl text-[10px] font-black border transition uppercase tracking-widest ${difficulty === k ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-white/5 border-white/5 text-gray-600 hover:border-white/10'}`}>{DIFFICULTIES[k].label}</button>))}</div>
                                        <button onClick={createRoom} className="w-full bg-gradient-to-r from-cyan-600 to-cyan-800 py-6 rounded-3xl font-black text-xl shadow-xl hover:shadow-cyan-500/20 transition-all uppercase tracking-tighter italic">Host Session</button>
                                    </div>
                                </div>
                                <button onClick={() => setScreen('welcome')} className="w-full text-gray-600 font-black hover:text-white transition uppercase text-[10px] tracking-[0.5em] italic">Abort Mission</button>
                            </div>
                        )}
                        {screen === 'lobby' && roomData && (
                            <div className="w-full space-y-8 animate-in zoom-in">
                                <div className="glass p-12 rounded-[3.5rem] text-center border-cyan-500/40 shadow-3xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-cyan-400 animate-pulse"></div>
                                    <span className="text-gray-600 text-[10px] uppercase font-black tracking-[0.4em]">Room Frequency Code</span>
                                    <h2 className="text-7xl font-black mt-4 tracking-[0.2em] neon-text italic tabular-nums italic">{roomId}</h2>
                                    <div className="mt-8 flex justify-center gap-6 text-[10px] font-black text-gray-500 uppercase tracking-widest italic"><span className="flex items-center gap-2 bg-black/40 px-4 py-2 rounded-full border border-white/5">TIME: {roomData.time}s</span><span className="flex items-center gap-2 bg-black/40 px-4 py-2 rounded-full border border-white/5">RANK: {DIFFICULTIES[difficulty].label}</span></div>
                                </div>
                                <div className="glass rounded-[3rem] overflow-hidden shadow-xl border-white/5">
                                    <div className="bg-white/5 p-5 font-black text-[10px] uppercase flex justify-between px-10 tracking-[0.3em] border-b border-white/5 items-center"><span>Connected Pilots</span><span className="bg-cyan-500/20 text-cyan-400 px-3 py-1 rounded-full border border-cyan-500/30">{Object.keys(roomData.players||{}).length}</span></div>
                                    <div className="p-6 space-y-3 max-h-56 overflow-y-auto">
                                        {Object.values(roomData.players||{}).map((p, i) => (
                                            <div key={i} className="flex items-center gap-5 p-5 bg-white/5 rounded-2xl border border-white/5 transition-all hover:bg-white/10 group">
                                                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-600 to-fuchsia-600 flex items-center justify-center font-black text-lg shadow-lg group-hover:scale-110 transition">{p.name[0]}</div>
                                                <span className="flex-1 font-black text-lg tracking-tight italic uppercase">{p.name} {p.name === playerName && '(YOU)'}</span>
                                                <div className="flex items-center gap-2 bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20"><div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div><span className="text-green-500 text-[9px] font-black uppercase tracking-widest">Ready</span></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {roomData.host === user?.uid ? (
                                    <button onClick={() => fb.api.updateDoc(fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId), { status: 'playing' })} className="w-full py-7 bg-gradient-to-r from-fuchsia-600 via-pink-600 to-purple-700 rounded-[2rem] font-black text-2xl shadow-2xl hover:scale-105 transition-all uppercase tracking-tighter italic">Launch Battle Sequence</button>
                                ) : <div className="text-center p-12 glass rounded-[3.5rem] animate-pulse font-black text-fuchsia-400 uppercase italic tracking-tighter bg-fuchsia-500/5 border-fuchsia-500/20 italic">Awaiting commander to launch...</div>}
                            </div>
                        )}
                        {screen === 'teacher-dashboard' && (
                            <div className="w-full space-y-8 animate-in fade-in">
                                <div className="flex justify-between items-center glass p-10 rounded-[3rem] border-fuchsia-500/30">
                                    <div className="flex items-center gap-5"><div className="w-12 h-12 bg-gradient-to-tr from-fuchsia-600 to-pink-600 rounded-2xl shadow-lg flex items-center justify-center font-black uppercase italic">TC</div><div><h2 className="text-2xl font-black italic uppercase tracking-tight">Pilot Logs</h2><p className="text-[9px] text-gray-500 font-black tracking-widest uppercase italic">Teacher Control Center</p></div></div>
                                    <button onClick={() => setScreen('welcome')} className="bg-white/5 hover:bg-white/10 px-6 py-2 rounded-xl text-[10px] font-black transition border border-white/10 uppercase tracking-widest">Close</button>
                                </div>
                                <div className="glass rounded-[3rem] overflow-hidden shadow-2xl border-white/5">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-right text-sm italic">
                                            <thead className="bg-white/5 text-[9px] font-black text-gray-600 uppercase tracking-[0.3em] border-b border-white/5"><tr><th className="p-6">Pilot Name</th><th className="p-6">Max Score</th><th className="p-6">Protocol</th><th className="p-6 text-left">Timestamp</th></tr></thead>
                                            <tbody className="divide-y divide-white/5 font-bold uppercase tracking-tight">
                                                {history.length ? history.map(h => (
                                                    <tr key={h.id} className="hover:bg-cyan-500/5 transition group">
                                                        <td className="p-6 group-hover:text-cyan-400 transition">{h.name}</td>
                                                        <td className="p-6 text-cyan-400 font-black text-2xl tabular-nums tracking-tighter italic">{h.score}</td>
                                                        <td className="p-6"><span className="bg-white/5 px-3 py-1 rounded-full text-[9px] font-black uppercase border border-white/10">{h.difficulty}</span></td>
                                                        <td className="p-6 text-[10px] text-gray-600 tabular-nums text-left">{new Date(h.timestamp).toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'})}</td>
                                                    </tr>
                                                )) : <tr><td colSpan="4" className="p-24 text-center text-gray-600 italic font-black uppercase tracking-widest text-xs opacity-50 italic">Empty logs - No flight data yet</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                        {screen === 'solo-config' && (
                            <div className="w-full space-y-12 animate-in fade-in">
                                <div className="text-center space-y-3"><h2 className="text-4xl font-black uppercase tracking-tighter italic italic">Manual <span className="text-cyan-400">Override</span></h2><p className="text-gray-600 font-black uppercase tracking-widest text-[10px]">Configure your training module</p></div>
                                <div className="grid grid-cols-4 gap-4">
                                    {TABLES_LIST.map(num => (
                                        <button key={num} onClick={() => setSelectedTables(p => p.includes(num) ? p.filter(n => n !== num) : [...p, num])} className={`py-6 rounded-[2rem] font-black text-3xl transition-all border-2 active:scale-90 shadow-lg ${selectedTables.includes(num) ? 'bg-cyan-600 border-cyan-400 text-white shadow-cyan-900/40' : 'bg-white/5 border-white/10 text-gray-700 hover:border-white/30'}`}>{num}</button>
                                    ))}
                                </div>
                                <button onClick={() => startGame()} disabled={selectedTables.length === 0} className="w-full py-7 bg-gradient-to-r from-cyan-600 to-blue-700 rounded-[2rem] font-black text-2xl shadow-2xl disabled:opacity-20 uppercase tracking-widest hover:scale-105 transition active:scale-95 italic">Initiate Flight</button>
                            </div>
                        )}
                    </main>
                    <footer className="mt-auto py-10 text-center text-gray-600 text-[9px] font-black border-t border-white/5 w-full shrink-0 tracking-[0.5em] uppercase bg-black/20 italic"> 转 砖专转  爪专 漏 2026</footer>
                    {feedback && (
                        <div className="fixed inset-0 flex items-center justify-center z-[200] pointer-events-none p-6"><div className={`text-7xl font-black italic px-20 py-10 rounded-[4rem] shadow-3xl border-4 uppercase animate-in zoom-in duration-150 text-center italic ${feedback.type==='correct'?'bg-green-600 border-green-300 text-white shadow-[0_0_60px_rgba(34,197,94,0.6)]':'bg-red-600 border-red-300 text-white shadow-[0_0_60px_rgba(239,68,68,0.6)]'}`}>{feedback.val}</div></div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>